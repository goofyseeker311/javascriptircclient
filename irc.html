<html>
<head><title>IRC client</title></head>
<body><table>
<tr><td colspan="2"><textarea id="irc" name="irc" rows="20" cols="80" readonly style="resize: none;"></textarea></td></tr>
<tr><td><input id="msg" name="msg" type="text" size="74"></td><td><button id="send" name="send" type="button">Send</td></tr>
</table></body>
<script>
const socket = new WebSocket('wss://localhost/wsirc');
var nick = "guest"+Math.floor(Math.random()*10000000);
var joined = false;
function submitMessage() {
  msgtext = document.getElementById("msg").value;
  cmdtext = "";
  if (msgtext.startsWith("/")) {
    cmdtext = msgtext.substring(1);
  } else if (msgtext.trim().length>0) {
    document.getElementById("irc").value += nick+":\t"+msgtext+"\n";
    cmdtext = "privmsg #public :"+msgtext;
  }
  if (cmdtext.length>0) {
    sendMessage(cmdtext);
  }
  document.getElementById("msg").value = "";
}
msg.addEventListener("keyup", function(event) { if (event.key === "Enter") {submitMessage();} });
send.onclick = function(){ submitMessage(); };
socket.onopen = function(event) { console.log("Connection open."); sendMessage("nick "+nick); sendMessage("user "+nick+" ws ws: "+nick+""); };
socket.onmessage = function(event) {
  reader = new FileReader();
  reader.onload = function(e) {
    messagetext = reader.result;
    if (messagetext!==null) {
      if (messagetext.toLowerCase().startsWith("ping :")) {
        sendMessage("pong :"+messagetext.substring(6));
        if (!joined) { joined = true; sendMessage("join #public"); }
      } else {
        msgparts = messagetext.split(" ");
        if (msgparts[1].toLowerCase()==="privmsg") {
          usrpart = msgparts[0].substring(1,msgparts[0].indexOf("!"));
          chnpart = msgparts[2];
          msgtext = messagetext.substring(messagetext.toLowerCase().indexOf(chnpart.toLowerCase())+chnpart.length+2);
          document.getElementById("irc").value += usrpart + ":\t" + msgtext;
        }
      }
    }
    console.log("Message from server: ", messagetext);
  };
  reader.readAsText(event.data);
};
socket.onclose = function(event) { console.log("Connection close."); };
function sendMessage(message) {
  const blob = new Blob([message+"\n"], {type: '' });
  socket.send(blob);
  console.log("Message to server: ", message);
}
</script>
</html>
